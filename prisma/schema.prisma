datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id                 String    @id @default(cuid())
  parentId           String?
  accountType        String    @db.VarChar(20)
  email              String?   @unique @db.VarChar(255)
  phone              String?   @unique @db.VarChar(20)
  passwordHash       String    @db.VarChar(255)
  username           String?   @unique @db.VarChar(100)
  firstLogin         Boolean   @default(true)
  isVerified         Boolean   @default(false)
  isActive           Boolean   @default(true)
  subscriptionId     String?
  subscriptionEndsAt DateTime?
  createdBy          String?
  createdAt          DateTime  @default(now())
  lastLogin          DateTime?
  lastActive         DateTime?

  parentUser          User?                @relation("ParentToSubAccounts", fields: [parentId], references: [id], onDelete: SetNull)
  subAccounts         User[]               @relation("ParentToSubAccounts")
  createdByUser       User?                @relation("CreatedBy", fields: [createdBy], references: [id], onDelete: SetNull)
  createdUsers        User[]               @relation("CreatedBy")
  profile             Profile?
  subscription        Subscription?
  refreshTokens       RefreshToken[]
  passwordResetTokens PasswordResetToken[]
  verificationCodes   VerificationCode[]
  loginAttempts       LoginAttempt[]
  sessions            Session[]

  learningPathProgress UserLearningPathProgress[]
  levelProgress        UserLevelProgress[]
  stepProgress         UserStepProgress[]
  lessonProgress       UserLessonProgress[]
  quizAttempts         QuizAttempt[]
  exerciseAttempts     ExerciseAttempt[]
  certificates         UserCertificate[]
  badges               UserBadge[]
  stats                UserStats?
  dailyActivity        UserDailyActivity[]

  subAccountControls SubAccountControl[] @relation("ParentControls")
  controlledByParent SubAccountControl[] @relation("SubAccountControlled")

  reportsSent      AccountReport[] @relation("ReportsSent")
  reportsGenerated AccountReport[] @relation("ReportsGenerated")

  notifications Notification[]
  transactions  Transaction[]

  @@index([parentId])
  @@index([accountType])
  @@map("users")
}

model Profile {
  id                String    @id @default(cuid())
  userId            String    @unique
  firstName         String    @db.VarChar(100)
  lastName          String    @db.VarChar(100)
  displayName       String?   @db.VarChar(100)
  birthDate         DateTime?
  avatarUrl         String?   @db.VarChar(500)
  timezone          String    @default("Europe/Paris") @db.VarChar(50)
  preferredLanguage String    @default("fr") @db.VarChar(10)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("profiles")
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @db.Text
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @db.Text
  userId    String
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_reset_tokens")
}

model VerificationCode {
  id           String   @id @default(cuid())
  userId       String?
  contactType  String
  contactValue String
  code         String
  type         String
  isUsed       Boolean  @default(false)
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("verification_codes")
}

model LoginAttempt {
  id        String   @id @default(cuid())
  userId    String?
  email     String?
  phone     String?
  success   Boolean
  ipAddress String?
  userAgent String?  @db.Text
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("login_attempts")
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  sessionToken String   @unique
  deviceInfo   Json?
  ipAddress    String?
  lastActivity DateTime @default(now())
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model SubAccountControl {
  id                     String   @id @default(cuid())
  parentUserId           String
  subAccountId           String
  dailyTimeLimitMinutes  Int      @default(120)
  weeklyTimeLimitMinutes Int      @default(840)
  bedtimeStart           String   @default("21:00") @db.VarChar(10)
  bedtimeEnd             String   @default("07:00") @db.VarChar(10)
  canPurchase            Boolean  @default(false)
  spendingLimitCoins     Int      @default(0)
  notificationsEnabled   Boolean  @default(true)
  progressReportsEnabled Boolean  @default(true)
  reportFrequency        String   @default("weekly") @db.VarChar(20)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  parentUser User @relation("ParentControls", fields: [parentUserId], references: [id], onDelete: Cascade)
  subAccount User @relation("SubAccountControlled", fields: [subAccountId], references: [id], onDelete: Cascade)

  @@unique([parentUserId, subAccountId])
  @@map("sub_account_controls")
}

model SubscriptionPlan {
  id             String   @id @default(cuid())
  planCode       String   @unique @db.VarChar(50)
  planName       String   @db.VarChar(100)
  description    String?  @db.Text
  priceMonthly   Decimal? @db.Decimal(10, 2)
  priceYearly    Decimal? @db.Decimal(10, 2)
  currency       String   @default("EUR") @db.VarChar(3)
  features       Json
  maxSubAccounts Int      @default(0)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  subscriptions Subscription[]

  @@map("subscription_plans")
}

model Subscription {
  id                 String    @id @default(cuid())
  userId             String    @unique
  planId             String
  status             String    @default("active") @db.VarChar(20)
  billingCycle       String    @default("monthly") @db.VarChar(20)
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelAtPeriodEnd  Boolean   @default(false)
  canceledAt         DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  user User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan SubscriptionPlan @relation(fields: [planId], references: [id])

  @@map("subscriptions")
}

model LearningPath {
  id          String   @id @default(cuid())
  title       String   @db.VarChar(200)
  description String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  levels       Level[]
  userProgress UserLearningPathProgress[]
  FinalExam    FinalExam?
  Certificate  Certificate[]

  @@map("learning_paths")
}

model Level {
  id             String   @id @default(cuid())
  learningPathId String
  name           String   @db.VarChar(100)
  description    String?  @db.Text
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  learningPath             LearningPath               @relation(fields: [learningPathId], references: [id], onDelete: Cascade)
  steps                    Step[]
  userProgress             UserLevelProgress[]
  LevelExam                LevelExam?
  UserLearningPathProgress UserLearningPathProgress[]

  @@map("levels")
}

model Step {
  id                     String    @id @default(cuid())
  levelId                String
  title                  String    @db.VarChar(200)
  description            String?   @db.Text
  stepNumber             Int
  stepCode               String    @db.VarChar(50)
  thumbnailUrl           String?   @db.VarChar(500)
  iconUrl                String?   @db.VarChar(500)
  estimatedDurationHours Int?      @default(1)
  difficultyLevel        String    @default("beginner") @db.VarChar(20)
  isPublished            Boolean   @default(false)
  publishedAt            DateTime?
  sortOrder              Int
  isActive               Boolean   @default(true)
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt

  level        Level              @relation(fields: [levelId], references: [id], onDelete: Cascade)
  lessons      Lesson[]
  userProgress UserStepProgress[]
  stepQuiz     StepQuiz?

  @@unique([levelId, stepNumber])
  @@map("steps")
}

model Lesson {
  id                       String   @id @default(cuid())
  stepId                   String
  title                    String   @db.VarChar(200)
  lessonNumber             Int
  contentType              String   @db.VarChar(30)
  contentUrl               String?  @db.VarChar(500)
  contentText              String?  @db.Text
  interactiveData          Json?
  estimatedDurationMinutes Int      @default(15)
  isFreePreview            Boolean  @default(false)
  sortOrder                Int
  isActive                 Boolean  @default(true)
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt

  step         Step                 @relation(fields: [stepId], references: [id], onDelete: Cascade)
  exercises    Exercise[]
  userProgress UserLessonProgress[]

  @@unique([stepId, lessonNumber])
  @@map("lessons")
}

model Exercise {
  id               String   @id @default(cuid())
  lessonId         String
  title            String   @db.VarChar(200)
  exerciseType     String   @db.VarChar(30)
  instructions     String?  @db.Text
  content          Json
  correctAnswers   Json?
  hints            Json?
  explanation      String?  @db.Text
  points           Int      @default(10)
  xpReward         Int      @default(10)
  coinReward       Int      @default(5)
  maxAttempts      Int      @default(3)
  timeLimitSeconds Int?
  sortOrder        Int
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  lesson   Lesson            @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  attempts ExerciseAttempt[]

  @@index([lessonId, sortOrder])
  @@map("exercises")
}

model StepQuiz {
  id               String   @id @default(cuid())
  stepId           String   @unique
  title            String   @db.VarChar(200)
  description      String?  @db.Text
  questions        Json
  passingScore     Int      @default(70)
  maxAttempts      Int      @default(3)
  timeLimitMinutes Int      @default(20)
  xpReward         Int      @default(80)
  coinReward       Int      @default(40)
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  step     Step          @relation(fields: [stepId], references: [id], onDelete: Cascade)
  attempts QuizAttempt[]

  @@map("step_quizzes")
}

model LevelExam {
  id                 String   @id @default(cuid())
  levelId            String   @unique
  title              String   @db.VarChar(200)
  description        String?  @db.Text
  sections           Json
  passingScore       Int      @default(75)
  maxAttempts        Int      @default(2)
  timeLimitMinutes   Int      @default(60)
  xpReward           Int      @default(500)
  coinReward         Int      @default(200)
  unlocksCertificate Boolean  @default(true)
  isActive           Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  level    Level         @relation(fields: [levelId], references: [id], onDelete: Cascade)
  attempts QuizAttempt[]

  @@map("level_exams")
}

model FinalExam {
  id                String   @id @default(cuid())
  learningPathId    String   @unique
  title             String   @db.VarChar(200)
  description       String?  @db.Text
  sections          Json
  passingScore      Int      @default(80)
  maxAttempts       Int      @default(1)
  timeLimitMinutes  Int      @default(120)
  xpReward          Int      @default(1000)
  coinReward        Int      @default(500)
  awardsCertificate Boolean  @default(true)
  certificateId     String?
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  learningPath LearningPath  @relation(fields: [learningPathId], references: [id], onDelete: Cascade)
  certificate  Certificate?  @relation(fields: [certificateId], references: [id], onDelete: SetNull)
  attempts     QuizAttempt[]

  @@map("final_exams")
}

model QuizAttempt {
  id               String    @id @default(cuid())
  userId           String
  quizType         String    @db.VarChar(20)
  stepQuizId       String?
  levelExamId      String?
  finalExamId      String?
  attemptNumber    Int
  score            Decimal   @db.Decimal(5, 2)
  answers          Json
  timeSpentSeconds Int
  status           String    @db.VarChar(20)
  passed           Boolean
  feedback         String?   @db.Text
  xpEarned         Int       @default(0)
  coinsEarned      Int       @default(0)
  startedAt        DateTime  @default(now())
  completedAt      DateTime?
  gradedAt         DateTime?
  createdAt        DateTime  @default(now())

  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  stepQuiz  StepQuiz?  @relation(fields: [stepQuizId], references: [id], onDelete: SetNull)
  levelExam LevelExam? @relation(fields: [levelExamId], references: [id], onDelete: SetNull)
  finalExam FinalExam? @relation(fields: [finalExamId], references: [id], onDelete: SetNull)

  @@unique([userId, quizType, stepQuizId, attemptNumber])
  @@unique([userId, quizType, levelExamId, attemptNumber])
  @@unique([userId, quizType, finalExamId, attemptNumber])
  @@map("quiz_attempts")
}

model ExerciseAttempt {
  id               String   @id @default(cuid())
  userId           String
  exerciseId       String
  attemptNumber    Int
  answers          Json
  score            Decimal? @db.Decimal(5, 2)
  pointsEarned     Int      @default(0)
  xpEarned         Int      @default(0)
  coinsEarned      Int      @default(0)
  timeSpentSeconds Int?
  isCorrect        Boolean?
  feedback         String?  @db.Text
  createdAt        DateTime @default(now())

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  exercise Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  @@unique([userId, exerciseId, attemptNumber])
  @@map("exercise_attempts")
}

model UserLearningPathProgress {
  id               String    @id @default(cuid())
  userId           String
  learningPathId   String
  status           String    @default("not_started") @db.VarChar(20)
  currentLevelId   String?
  overallProgress  Decimal   @default(0.0) @db.Decimal(5, 2)
  totalXp          Int       @default(0)
  totalTimeMinutes Int       @default(0)
  finalExamScore   Decimal?  @db.Decimal(5, 2)
  startedAt        DateTime?
  completedAt      DateTime?
  lastAccessedAt   DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  learningPath LearningPath @relation(fields: [learningPathId], references: [id], onDelete: Cascade)
  currentLevel Level?       @relation(fields: [currentLevelId], references: [id], onDelete: SetNull)

  @@unique([userId, learningPathId])
  @@map("user_learning_path_progress")
}

model UserLevelProgress {
  id                 String    @id @default(cuid())
  userId             String
  levelId            String
  status             String    @default("locked") @db.VarChar(20)
  currentStepNumber  Int       @default(1)
  progressPercentage Decimal   @default(0.0) @db.Decimal(5, 2)
  totalXp            Int       @default(0)
  timeSpentMinutes   Int       @default(0)
  levelExamScore     Decimal?  @db.Decimal(5, 2)
  unlockedAt         DateTime?
  startedAt          DateTime?
  completedAt        DateTime?
  lastAccessedAt     DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  level Level @relation(fields: [levelId], references: [id], onDelete: Cascade)

  @@unique([userId, levelId])
  @@map("user_level_progress")
}

model UserStepProgress {
  id                  String    @id @default(cuid())
  userId              String
  stepId              String
  status              String    @default("locked") @db.VarChar(20)
  currentLessonNumber Int       @default(1)
  progressPercentage  Decimal   @default(0.0) @db.Decimal(5, 2)
  totalXp             Int       @default(0)
  timeSpentMinutes    Int       @default(0)
  quizScore           Decimal?  @db.Decimal(5, 2)
  unlockedAt          DateTime?
  startedAt           DateTime?
  completedAt         DateTime?
  lastAccessedAt      DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  step Step @relation(fields: [stepId], references: [id], onDelete: Cascade)

  @@unique([userId, stepId])
  @@map("user_step_progress")
}

model UserLessonProgress {
  id          String    @id @default(cuid())
  userId      String
  lessonId    String
  status      String    @default("not_started") @db.VarChar(20)
  progress    Decimal   @default(0.0) @db.Decimal(5, 2)
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@map("user_lesson_progress")
}

model Certificate {
  id             String   @id @default(cuid())
  learningPathId String?
  certCode       String   @unique @db.VarChar(50)
  certName       String   @db.VarChar(200)
  description    String?  @db.Text
  iconUrl        String?  @db.VarChar(500)
  bannerUrl      String?  @db.VarChar(500)
  requirements   Json
  validityDays   Int?
  xpReward       Int      @default(500)
  coinReward     Int      @default(200)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  learningPath     LearningPath?     @relation(fields: [learningPathId], references: [id], onDelete: SetNull)
  userCertificates UserCertificate[]
  finalExams       FinalExam[]

  @@map("certificates")
}

model UserCertificate {
  id                String    @id @default(cuid())
  userId            String
  certificateId     String
  certificateNumber String    @unique @db.VarChar(100)
  issueDate         DateTime
  expiryDate        DateTime?
  score             Decimal?  @db.Decimal(5, 2)
  status            String    @default("active") @db.VarChar(20)
  downloadUrl       String?   @db.VarChar(500)
  qrCodeUrl         String?   @db.VarChar(500)
  data              Json?
  createdAt         DateTime  @default(now())

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  certificate Certificate @relation(fields: [certificateId], references: [id], onDelete: Cascade)

  @@unique([userId, certificateId])
  @@map("user_certificates")
}

model Badge {
  id          String   @id @default(cuid())
  badgeCode   String   @unique @db.VarChar(50)
  badgeName   String   @db.VarChar(100)
  description String?  @db.Text
  category    String?  @db.VarChar(30)
  iconUrl     String?  @db.VarChar(500)
  colorCode   String?  @db.VarChar(7)
  rarity      String   @default("common") @db.VarChar(20)
  criteria    Json
  xpReward    Int      @default(50)
  coinReward  Int      @default(100)
  isSecret    Boolean  @default(false)
  createdAt   DateTime @default(now())

  userBadges UserBadge[]

  @@map("badges")
}

model UserBadge {
  id         String   @id @default(cuid())
  userId     String
  badgeId    String
  unlockedAt DateTime @default(now())
  isFavorite Boolean  @default(false)
  createdAt  DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge Badge @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
  @@map("user_badges")
}

model UserStats {
  id                      String   @id @default(cuid())
  userId                  String   @unique
  totalXp                 BigInt   @default(0)
  totalCoins              Int      @default(0)
  currentStreak           Int      @default(0)
  longestStreak           Int      @default(0)
  totalStudyMinutes       Int      @default(0)
  totalExercisesCompleted Int      @default(0)
  totalLessonsCompleted   Int      @default(0)
  totalStepsCompleted     Int      @default(0)
  totalLevelsCompleted    Int      @default(0)
  totalCertificatesEarned Int      @default(0)
  totalBadgesEarned       Int      @default(0)
  accuracyRate            Decimal? @db.Decimal(5, 2)
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_stats")
}

model UserDailyActivity {
  id                 String    @id @default(cuid())
  userId             String
  activityDate       DateTime
  studyMinutes       Int       @default(0)
  lessonsCompleted   Int       @default(0)
  exercisesCompleted Int       @default(0)
  stepsCompleted     Int       @default(0)
  xpEarned           Int       @default(0)
  coinsEarned        Int       @default(0)
  badgesEarned       Int       @default(0)
  streakMaintained   Boolean?
  firstActivityAt    DateTime?
  lastActivityAt     DateTime?
  createdAt          DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, activityDate])
  @@map("user_daily_activity")
}

model AccountReport {
  id                  String    @id @default(cuid())
  parentUserId        String
  subAccountId        String
  reportType          String    @default("weekly") @db.VarChar(30)
  periodStart         DateTime
  periodEnd           DateTime
  summary             Json
  achievements        Json?
  areasForImprovement Json?
  recommendations     Json?
  totalStudyMinutes   Int?
  lessonsCompleted    Int?
  exercisesCompleted  Int?
  stepsCompleted      Int?
  levelsCompleted     Int?
  xpEarned            Int?
  coinsEarned         Int?
  badgesEarned        Int?
  certificatesEarned  Int?
  isViewed            Boolean   @default(false)
  viewedAt            DateTime?
  generatedAt         DateTime  @default(now())
  createdAt           DateTime  @default(now())

  parentUser User @relation("ReportsSent", fields: [parentUserId], references: [id], onDelete: Cascade)
  subAccount User @relation("ReportsGenerated", fields: [subAccountId], references: [id], onDelete: Cascade)

  @@index([parentUserId, periodStart, periodEnd])
  @@map("account_reports")
}

model Notification {
  id               String    @id @default(cuid())
  userId           String
  notificationType String?   @db.VarChar(30)
  title            String    @db.VarChar(200)
  message          String    @db.Text
  iconUrl          String?   @db.VarChar(500)
  actionUrl        String?   @db.VarChar(500)
  isRead           Boolean   @default(false)
  readAt           DateTime?
  expiresAt        DateTime?
  createdAt        DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model Transaction {
  id                String   @id @default(cuid())
  userId            String
  transactionType   String   @db.VarChar(30)
  amountCoins       Int?
  description       String?  @db.VarChar(500)
  referenceType     String?  @db.VarChar(50)
  referenceId       String?
  balanceCoinsAfter Int?
  metadata          Json?
  createdAt         DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@map("transactions")
}
